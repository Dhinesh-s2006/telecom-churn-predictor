<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Churn Predictor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'churn-primary': '#1D4ED8', // Darker Blue for primary elements
                        'churn-secondary': '#F9FAFB', // Light Gray background for inputs
                    },
                    boxShadow: {
                        'premium': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                        'input-focus': '0 0 0 3px rgba(29, 78, 216, 0.5)', // Blue focus ring
                    }
                }
            }
        }
    </script>  
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #f0f4f8 0%, #ffffff 100%); 
        }
        .card { 
            /* Apply premium shadow */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); 
            transition: all 0.3s ease;
        }
        /* Custom risk colors with good contrast */
        .risk-low { background-color: #059669; } /* Emerald Green */
        .risk-medium { background-color: #FBBF24; } /* Amber Yellow */
        .risk-high { background-color: #DC2626; } /* Crimson Red */
        
        /* Input focus using custom shadow */
        input:focus, select:focus {
            border-color: #1D4ED8 !important; 
            box-shadow: 0 0 0 3px rgba(29, 78, 216, 0.5) !important;
        }
        
        /* Custom Loading Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex items-center justify-center">

<div class="w-full max-w-5xl">
    <h1 class="text-5xl font-black text-center text-gray-800 mb-10 tracking-tight">
        <span class="text-churn-primary">Telecom</span> Churn Prediction Engine
    </h1>

    <div id="input-card" class="card bg-white p-6 sm:p-12 rounded-3xl border border-gray-100">
        <h2 class="text-2xl font-bold text-gray-800 mb-8 border-b pb-4">Customer Profile Input</h2>

        <form id="churn-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-6">
            
            <div class="col-span-1">
                <label for="tenure" class="block text-sm font-semibold text-gray-700 mb-2">Tenure (Months)</label>
                <input type="number" id="tenure" value="24" min="1" class="w-full p-4 bg-churn-secondary border border-gray-300 rounded-xl transition duration-200" required>
            </div>
            <div class="col-span-1">
                <label for="monthlyCharges" class="block text-sm font-semibold text-gray-700 mb-2">Monthly Charges ($)</label>
                <input type="number" id="monthlyCharges" value="70.00" min="0" step="0.01" class="w-full p-4 bg-churn-secondary border border-gray-300 rounded-xl transition duration-200" required>
            </div>
            <div class="col-span-1">
                <label for="totalCharges" class="block text-sm font-semibold text-gray-700 mb-2">Total Charges ($)</label>
                <input type="number" id="totalCharges" value="1680.00" min="0" step="0.01" class="w-full p-4 bg-churn-secondary border border-gray-300 rounded-xl transition duration-200" required>
            </div>

            <div class="col-span-1">
                <label for="contract" class="block text-sm font-semibold text-gray-700 mb-2">Contract Type</label>
                <select id="contract" class="w-full p-4 bg-churn-secondary border border-gray-300 rounded-xl transition duration-200">
                    <option value="Month-to-month">Month-to-month</option>
                    <option value="One year">One year</option>
                    <option value="Two year">Two year</option>
                </select>
            </div>
            <div class="col-span-1">
                <label for="SeniorCitizen" class="block text-sm font-semibold text-gray-700 mb-2">Is Senior Citizen?</label>
                <select id="SeniorCitizen" class="w-full p-4 bg-churn-secondary border border-gray-300 rounded-xl transition duration-200">
                    <option value="No">No</option>
                    <option value="Yes">Yes</option>
                </select>
            </div>
            <div class="col-span-1">
                <label for="PaperlessBilling" class="block text-sm font-semibold text-gray-700 mb-2">Paperless Billing?</label>
                <select id="PaperlessBilling" class="w-full p-4 bg-churn-secondary border border-gray-300 rounded-xl transition duration-200">
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>
            </div>
            
            <div class="col-span-1">
                <label for="partner" class="block text-sm font-semibold text-gray-700 mb-2">Has Partner?</label>
                <select id="partner" class="w-full p-4 bg-churn-secondary border border-gray-300 rounded-xl transition duration-200">
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>
            </div>
            <div class="col-span-1">
                <label for="dependents" class="block text-sm font-semibold text-gray-700 mb-2">Has Dependents?</label>
                <select id="dependents" class="w-full p-4 bg-churn-secondary border border-gray-300 rounded-xl transition duration-200">
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>
            </div>
            <div class="col-span-1">
                <label for="PaymentMethod" class="block text-sm font-semibold text-gray-700 mb-2">Payment Method</label>
                <select id="PaymentMethod" class="w-full p-4 bg-churn-secondary border border-gray-300 rounded-xl transition duration-200">
                    <option value="Electronic check">Electronic check</option>
                    <option value="Mailed check">Mailed check</option>
                    <option value="Bank transfer (automatic)">Bank transfer (automatic)</option>
                    <option value="Credit card (automatic)">Credit card (automatic)</option>
                </select>
            </div>

            <div class="md:col-span-3 mt-4">
                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Value-Added Services</h3>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <div><input type="checkbox" id="MultipleLines" class="rounded text-churn-primary focus:ring-churn-primary"><label for="MultipleLines" class="ml-2 text-sm text-gray-700 font-medium">Multiple Lines</label></div>
                    <div><input type="checkbox" id="OnlineSecurity" class="rounded text-churn-primary focus:ring-churn-primary"><label for="OnlineSecurity" class="ml-2 text-sm text-gray-700 font-medium">Online Security</label></div>
                    <div><input type="checkbox" id="OnlineBackup" class="rounded text-churn-primary focus:ring-churn-primary"><label for="OnlineBackup" class="ml-2 text-sm text-gray-700 font-medium">Online Backup</label></div>
                    <div><input type="checkbox" id="DeviceProtection" class="rounded text-churn-primary focus:ring-churn-primary"><label for="DeviceProtection" class="ml-2 text-sm text-gray-700 font-medium">Device Protection</label></div>
                    <div><input type="checkbox" id="TechSupport" class="rounded text-churn-primary focus:ring-churn-primary"><label for="TechSupport" class="ml-2 text-sm text-gray-700 font-medium">Tech Support</label></div>
                    <div><input type="checkbox" id="StreamingTV" class="rounded text-churn-primary focus:ring-churn-primary"><label for="StreamingTV" class="ml-2 text-sm text-gray-700 font-medium">Streaming TV</label></div>
                    <div><input type="checkbox" id="StreamingMovies" class="rounded text-churn-primary focus:ring-churn-primary"><label for="StreamingMovies" class="ml-2 text-sm text-gray-700 font-medium">Streaming Movies</label></div>
                </div>
            </div>

            <div class="md:col-span-3 mt-6">
                <button type="submit" id="predict-button" class="w-full py-4 px-4 bg-churn-primary text-white font-extrabold rounded-xl transition duration-300 shadow-xl transform hover:scale-[1.005] active:scale-[0.99] active:shadow-md flex items-center justify-center space-x-3">
                    <span>Predict Churn Risk</span>
                    </button>
            </div>
        </form>
    </div>

    <div id="result-card" class="card bg-white p-6 sm:p-12 rounded-3xl border border-gray-100 mt-8 hidden">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Prediction Outcome</h2>
        <div id="risk-display" class="w-full h-36 flex items-center justify-center rounded-2xl transition duration-700">
            <p class="text-4xl sm:text-5xl font-extrabold text-white text-center" id="risk-text">Calculating...</p>
        </div>

        <div class="mt-8 border-t pt-6">
            <h3 class="text-xl font-bold mb-3 text-gray-800">Feature Insights</h3>
            <p class="text-sm text-gray-600 mb-4">The prediction is based on the following constructed features (calculated consistently with the model):</p>
            <ul class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-gray-700">
                <li id="ft-tenure-group" class="p-3 bg-gray-50 rounded-lg border border-gray-200">Tenure Stage: <span class="font-bold text-churn-primary">...</span></li>
                <li id="ft-num-services" class="p-3 bg-gray-50 rounded-lg border border-gray-200">Total Services Used: <span class="font-bold text-churn-primary">...</span></li>
                <li id="ft-spending-level" class="p-3 bg-gray-50 rounded-lg border border-gray-200">Spending Level (from TotalCharges): <span class="font-bold text-churn-primary">...</span></li>
                <li id="ft-loyalty-flag" class="p-3 bg-gray-50 rounded-lg border border-gray-200">Low-Value Loyal Flag: <span class="font-bold text-churn-primary">...</span></li>
                <li id="ft-charge-dev" class="p-3 bg-gray-50 rounded-lg border border-gray-200">Charge Deviation Indicator: <span class="font-bold text-churn-primary">...</span></li>
            </ul>
        </div>
        <div class="p-4 mt-4 mb-6 rounded-xl bg-churn-secondary border-2 border-dashed border-churn-primary">
    <p class="text-md font-bold text-gray-800">Retention Policy Recommendation:</p>
    <p class="text-lg font-extrabold text-churn-primary mt-1" id="treatment-recommendation">Calculating...</p>
</div>
        <button onclick="document.getElementById('result-card').classList.add('hidden')" class="w-full py-3 mt-6 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition duration-200">
            Close Result
        </button>
    </div>
</div>

<script>
    // --- CONSTANTS NEEDED FOR DISPLAY CALCULATIONS (MUST MATCH PYTHON LOGIC!) ---
    const TRAINING_MONTHLY_CHARGES_MEDIAN = 64.85189431704886; 
    const TOTAL_CHARGES_QUANTILES = [18.80, 685.55,2751.00, 8684.8]; 
    const TENURE_BINS = [0, 12, 36, 60, 100];
    const TENURE_LABELS = ['New', 'Mid-Term', 'Loyal', 'Veteran'];
    const SERVICE_COLS = ["MultipleLines", "OnlineSecurity", "OnlineBackup", "DeviceProtection", "TechSupport", "StreamingTV", "StreamingMovies"];
    
    // Get the button element
    const predictButton = document.getElementById('predict-button');

    document.getElementById('churn-form').addEventListener('submit', function(e) {
        e.preventDefault();
        predictChurn();
    });

    // --- Loading State Functions ---
    function showLoading() {
        predictButton.disabled = true;
        predictButton.innerHTML = 'Predicting... <div class="spinner ml-3"></div>';
    }

    function hideLoading(originalText) {
        predictButton.disabled = false;
        predictButton.innerHTML = `<span>${originalText}</span>`;
    }
    // ---------------------------------

    /**
     * Gathers raw input, calculates display-only features, and calls the Flask API for the real prediction.
     */
    function predictChurn() {
        const originalButtonText = "Predict Churn Risk";
        showLoading();

        // 1. GATHER ALL RAW INPUTS and calculate display features
        const tenure = parseFloat(document.getElementById('tenure').value);
        const monthlyCharges = parseFloat(document.getElementById('monthlyCharges').value);
        const totalCharges = parseFloat(document.getElementById('totalCharges').value);
        
        // --- 1a. Data to Send to Flask (MUST include ALL raw features) ---
        const dataToSend = {
            // Numeric
            tenure: tenure,
            MonthlyCharges: monthlyCharges,
            TotalCharges: totalCharges,
            // Select/Dropdowns (Categorical)
            Contract: document.getElementById('contract').value,
            Partner: document.getElementById('partner').value,
            Dependents: document.getElementById('dependents').value,
            SeniorCitizen: document.getElementById('SeniorCitizen').value,
            PaperlessBilling: document.getElementById('PaperlessBilling').value,
            PaymentMethod: document.getElementById('PaymentMethod').value,
        };

        // --- 1b. Calculate Display Features & Add Service Columns to dataToSend ---
        let numServices = 0;
        let tenureGroup = '';
        let loyaltyFlag = 0;
        let spendingLevel = '';
        let chargeDevIndicator = '';
        
        // NumServices and Service Columns for API
        SERVICE_COLS.forEach(id => {
            const isChecked = document.getElementById(id).checked;
            dataToSend[id] = isChecked ? 'Yes' : 'No';
            numServices += isChecked ? 1 : 0;
        });

        // TenureGroup (for display)
        if (tenure <= TENURE_BINS[1]) { tenureGroup = TENURE_LABELS[0]; } 
        else if (tenure <= TENURE_BINS[2]) { tenureGroup = TENURE_LABELS[1]; } 
        else if (tenure <= TENURE_BINS[3]) { tenureGroup = TENURE_LABELS[2]; } 
        else { tenureGroup = TENURE_LABELS[3]; }

        // LoyaltyFlag (for display)
        loyaltyFlag = (tenure > 24 && monthlyCharges < TRAINING_MONTHLY_CHARGES_MEDIAN) ? 1 : 0;
        
        // Spending Level (for display)
        if (totalCharges <= TOTAL_CHARGES_QUANTILES[1]) { spendingLevel = 'Low'; } 
        else if (totalCharges <= TOTAL_CHARGES_QUANTILES[2]) { spendingLevel = 'Medium'; } 
        else { spendingLevel = 'High'; }
        
        // Charge Deviation (for display)
        const expectedTotalCharges = monthlyCharges * tenure;
        const chargeDeviation = totalCharges - expectedTotalCharges;
        chargeDevIndicator = 'Neutral';
        if (tenure > 1 && totalCharges > 0) { 
             const deviationPercent = chargeDeviation / totalCharges;
             if (deviationPercent > 0.05) { chargeDevIndicator = 'High Surprise (Risk)'; } 
             else if (deviationPercent < -0.05) { chargeDevIndicator = 'Big Discount (Benefit)'; }
        }
        // ------------------------------------------------------------------------

        // 2. MAKE API CALL TO FLASK
        fetch('http://127.0.0.1:5000/predict_churn', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dataToSend)
        })
        .then(response => {
            if (!response.ok) {
                // Read and throw the error message from Flask for better debugging
                return response.json().then(err => { throw new Error(err.error || "Server responded with an unknown error."); });
            }
            return response.json();
        })
        .then(data => {
            hideLoading(originalButtonText);
            if (data.status === 'success') {
                const riskScore = data.churn_probability; 
                const riskPercentage = Math.round(riskScore * 100);

                // --- 3. DISPLAY RESULTS ---
                let riskStatus = '';
                let riskClass = '';
                let treatmentRecommendation = '';

                // Determine risk class and treatment based on thresholds
                // After (More Sensitive - LOW < 25%, MEDIUM < 50%)
if (riskPercentage <55) { 
    riskStatus = 'LOW RISK'; riskClass = 'risk-low'; 
treatmentRecommendation = 'STATUS QUO: Maintain service standards. Avoid offering discounts to protect profit margin. Focus on general customer satisfaction surveys.';
} else { // HIGH RISK starts here (50%+)
    riskStatus = 'HIGH RISK'; riskClass = 'risk-high'; 
treatmentRecommendation = 'URGENT INTERVENTION: Authorize a high-value retention offer immediately. Recommend a specialist call with a pre-approved discount (e.g., 20% off for 6 months) or offer a plan consolidation.';
}

                const resultCard = document.getElementById('result-card');
                const riskDisplay = document.getElementById('risk-display');
                const riskText = document.getElementById('risk-text');
                
                // Update main result display
                riskDisplay.className = `w-full h-36 flex items-center justify-center rounded-2xl transition duration-700 ${riskClass}`;
                riskText.textContent = `${riskPercentage}-${riskStatus}`;
                
                // Update Feature Insights and Recommendation
                document.getElementById('ft-tenure-group').querySelector('span').textContent = tenureGroup;
                document.getElementById('ft-num-services').querySelector('span').textContent = numServices;
                document.getElementById('ft-spending-level').querySelector('span').textContent = spendingLevel;
                document.getElementById('ft-loyalty-flag').querySelector('span').textContent = loyaltyFlag === 1 ? 'Yes (Low-Value Loyal)' : 'No';
                document.getElementById('ft-charge-dev').querySelector('span').textContent = chargeDevIndicator;
                document.getElementById('treatment-recommendation').textContent = treatmentRecommendation; // Set the new recommendation text

                // Show the card
                resultCard.classList.remove('hidden');
                window.scrollTo({ top: resultCard.offsetTop - 100, behavior: 'smooth' });
            } else {
                alert("Prediction failed on server: " + (data.error || "Unknown error."));
            }
        })
        .catch(error => {
            // This catches network errors or errors thrown from the response handling above
            hideLoading(originalButtonText);
            alert(`A critical error occurred: ${error.message}. Ensure app.py is running.`);
            console.error('Fetch error:', error);
        });
    }
</script>
</body>
</html>